import{g as ae,u as le,r as ne,b as re}from"./cart-Cx8k0y7Y.js";import{c as de}from"./order-CZwpuBcY.js";import{d as ie,r as f,D as ce,n as ue,o as r,c as m,b as l,w as o,e as a,H as P,q as h,F as w,G as E,f as v,t as _,K as M,u as k,g as pe,E as n,h as c,I as fe,M as me,N as _e,O as ve,B as ye,P as ge,Q as he}from"./index-Ba8PhKSB.js";import{a as ke}from"./address-DrSDh0H_.js";import{r as xe}from"./user-CswI-_sj.js";const we=()=>xe({url:"/user-coupons",method:"get"}),be={class:"cart-container"},Ve={class:"cart-content"},Ce={class:"item-content"},Ie={class:"item-info"},Ue={class:"item-name"},$e={class:"item-price"},Ae={class:"item-actions"},Be={class:"footer-content"},De={class:"total-price"},ze={class:"price"},Le={class:"address-form"},Ne={class:"address-info"},Se={class:"address-header"},qe={class:"receiver"},Pe={class:"phone"},Ee={class:"address-content"},Me={class:"address-actions"},Oe={style:{"max-height":"300px","overflow-y":"auto"}},Te={style:{padding:"8px 0"}},Fe={style:{display:"flex","justify-content":"space-between","align-items":"center",width:"100%"}},Qe={style:{display:"flex","align-items":"center",gap:"12px"}},je={style:{color:"var(--el-color-danger)","font-size":"16px","font-weight":"bold","min-width":"80px"}},Re={style:{display:"flex","flex-direction":"column",gap:"4px"}},Ge={style:{color:"var(--el-text-color-secondary)","font-size":"12px"}},He={style:{color:"var(--el-text-color-secondary)","font-size":"12px"}},Ke={class:"dialog-footer"},tt=ie({__name:"cart",setup(Je){const b=pe(),u=f([]),B=f(!0),O=f(null),y=f(0),U=f(""),V=f(!1),x=f([]),D=f(!1),C=f(0),$=f([]),z=f(!1),T=ce(()=>u.value.filter(s=>s.selected===1).reduce((s,e)=>s+(e.product.productPrice||0)*e.quantity,0)),F=s=>s?s.toLocaleString():"0",R=async()=>{var s;try{B.value=!0;const d=(await ae()).data;d.code===200&&(u.value=d.data||[])}catch(e){((s=e.response)==null?void 0:s.status)===401?n.error("请先登录"):n.error(e.message||"获取购物车列表失败")}finally{B.value=!1}},G=async(s,e)=>{if(!(e<1))try{const i=(await le(s.id,e)).data;i.code===200?(s.quantity=e,n.success("更新数量成功")):n.error(i.message||"更新数量失败")}catch{n.error("更新数量失败")}},H=async s=>{try{await he.confirm("确定要删除这个商品吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),O.value=s.id;const e=await ne(s.productId);if(e.data){const d=e.data;d.code===200?(u.value=u.value.filter(i=>i.id!==s.id),n.success("删除成功")):n.error(d.message||"删除失败")}else n.error("删除失败")}catch(e){e!=="cancel"&&n.error("删除失败")}finally{O.value=null}},K=async s=>{try{const e=s.selected===1?0:1,i=(await re(s.id,e)).data;i.code===200?s.selected=e:n.error(i.message||"更新选中状态失败")}catch{n.error("更新选中状态失败")}},J=async()=>{try{D.value=!0;const s=await ke.getAddressList();if(s.data.code===200){x.value=s.data.data;const e=x.value.find(d=>d.isDefault);e?y.value=e.id:x.value.length>0&&(y.value=x.value[0].id)}}catch{n.error("获取地址列表失败")}finally{D.value=!1}},W=async()=>{try{z.value=!0;const s=await we();s.data.code===200&&($.value=s.data.data.filter(e=>e.status===0))}catch{n.error("获取优惠券列表失败")}finally{z.value=!1}},X=()=>{if(u.value.filter(e=>e.selected===1).length===0){n.warning("请选择要结算的商品");return}V.value=!0,J(),W()},Y=async()=>{var s,e,d;if(!y.value){n.warning("请选择收货地址");return}try{const L={cartIds:u.value.filter(p=>p.selected===1).map(p=>p.id),addressId:y.value,remark:U.value||"",userCouponId:C.value||void 0};if(!localStorage.getItem("token")){n.error("请先登录"),b.push("/login");return}const I=await de(L);I.data.code===200?(u.value=u.value.filter(p=>p.selected!==1),n.success("订单创建成功"),V.value=!1,b.push(`/order/${I.data.data.id}`)):n.error(I.data.message||"创建订单失败")}catch(i){console.error("创建订单失败:",i),((s=i.response)==null?void 0:s.status)===401?(n.error("请先登录"),b.push("/login")):n.error(((d=(e=i.response)==null?void 0:e.data)==null?void 0:d.message)||"创建订单失败")}};return ue(()=>{R()}),(s,e)=>{const d=c("el-card"),i=c("el-empty"),L=c("el-checkbox"),A=c("el-icon"),I=c("el-input-number"),p=c("el-button"),Z=c("el-tag"),N=c("el-radio"),Q=c("el-radio-group"),ee=c("el-link"),S=c("el-form-item"),j=c("el-input"),te=c("el-popover"),se=c("el-form"),oe=c("el-dialog"),q=fe("loading");return r(),m("div",be,[l(d,{class:"page-header"},{header:o(()=>e[7]||(e[7]=[a("div",{class:"header"},[a("span",{class:"title"},"购物车")],-1)])),_:1}),P((r(),m("div",Ve,[u.value.length===0?(r(),h(i,{key:0,description:"购物车是空的"})):(r(),m(w,{key:1},[(r(!0),m(w,null,E(u.value,t=>(r(),h(d,{key:t.id,class:"cart-item"},{default:o(()=>[a("div",Ce,[l(L,{modelValue:t.selected,"onUpdate:modelValue":g=>t.selected=g,"true-label":1,"false-label":0,onChange:()=>K(t)},null,8,["modelValue","onUpdate:modelValue","onChange"]),a("div",Ie,[a("h3",Ue,_(t.product.productName),1),a("div",$e,"¥"+_(F(t.product.productPrice)),1)]),a("div",Ae,[l(I,{modelValue:t.quantity,"onUpdate:modelValue":g=>t.quantity=g,min:1,max:99,size:"small",onChange:g=>G(t,g)},{decrease:o(()=>[l(A,null,{default:o(()=>[l(k(me))]),_:1})]),increase:o(()=>[l(A,null,{default:o(()=>[l(k(_e))]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),l(p,{type:"danger",icon:k(ve),circle:"",onClick:g=>H(t)},null,8,["icon","onClick"])])])]),_:2},1024))),128)),u.value.length>0?(r(),h(d,{key:0,class:"cart-footer"},{default:o(()=>[a("div",Be,[a("div",De,[e[8]||(e[8]=v(" 总计: ")),a("span",ze,"¥"+_(F(T.value)),1)]),l(p,{type:"primary",size:"large",onClick:X,disabled:!u.value.some(t=>t.selected===1)},{default:o(()=>e[9]||(e[9]=[v(" 结算 ")])),_:1},8,["disabled"])])]),_:1})):M("",!0)],64))])),[[q,B.value]]),l(oe,{modelValue:V.value,"onUpdate:modelValue":e[6]||(e[6]=t=>V.value=t),title:"选择收货地址",width:"50%","close-on-click-modal":!1},{footer:o(()=>[a("span",Ke,[l(p,{onClick:e[5]||(e[5]=t=>V.value=!1)},{default:o(()=>e[14]||(e[14]=[v("取消")])),_:1}),l(p,{type:"primary",onClick:Y,disabled:!y.value},{default:o(()=>e[15]||(e[15]=[v(" 提交订单 ")])),_:1},8,["disabled"])])]),default:o(()=>[P((r(),m("div",Le,[l(se,{model:{addressId:y.value,remark:U.value},"label-width":"100px"},{default:o(()=>[l(S,{label:"收货地址",required:""},{default:o(()=>[x.value.length===0?(r(),h(i,{key:0,description:"暂无收货地址"},{default:o(()=>[l(p,{type:"primary",onClick:e[0]||(e[0]=t=>k(b).push("/address"))},{default:o(()=>e[10]||(e[10]=[v(" 添加收货地址 ")])),_:1})]),_:1})):(r(),h(Q,{key:1,modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=t=>y.value=t),class:"address-list"},{default:o(()=>[(r(!0),m(w,null,E(x.value,t=>(r(),h(N,{key:t.id,label:t.id,class:"address-item"},{default:o(()=>[a("div",Ne,[a("div",Se,[a("span",qe,_(t.receiverName),1),a("span",Pe,_(t.receiverPhone),1),t.isDefault?(r(),h(Z,{key:0,size:"small",type:"success"},{default:o(()=>e[11]||(e[11]=[v("默认")])),_:1})):M("",!0)]),a("div",Ee,_(`${t.province}${t.city}${t.district}${t.detailAddress}`),1)])]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])),a("div",Me,[l(ee,{type:"primary",onClick:e[2]||(e[2]=t=>k(b).push("/address"))},{default:o(()=>e[12]||(e[12]=[v(" 管理收货地址 ")])),_:1})])]),_:1}),l(S,{label:"订单备注"},{default:o(()=>[l(j,{modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=t=>U.value=t),type:"textarea",rows:3,placeholder:"请输入订单备注（选填）"},null,8,["modelValue"])]),_:1}),l(S,{label:"优惠券"},{default:o(()=>[P((r(),m("div",null,[l(te,{placement:"bottom-start",width:400,trigger:"click","popper-class":"coupon-popover"},{reference:o(()=>{var t;return[l(j,{readonly:"",placeholder:C.value===0?"不使用优惠券":((t=$.value.find(g=>g.id===C.value))==null?void 0:t.coupon.name)||"请选择优惠券","suffix-icon":k(ye),style:{width:"100%"}},null,8,["placeholder","suffix-icon"])]}),default:o(()=>[a("div",Oe,[l(Q,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=t=>C.value=t),style:{width:"100%"}},{default:o(()=>[a("div",Te,[l(N,{label:0,style:{width:"100%",margin:"0",padding:"8px 16px"}},{default:o(()=>e[13]||(e[13]=[a("div",{style:{display:"flex","justify-content":"space-between","align-items":"center",width:"100%"}},[a("span",null,"不使用优惠券"),a("span",{style:{color:"var(--el-text-color-secondary)"}},"按原价支付")],-1)])),_:1})]),(r(!0),m(w,null,E($.value,t=>(r(),m("div",{key:t.id,style:{padding:"4px 0"}},[l(N,{label:t.id,disabled:t.coupon.minAmount>T.value,style:{width:"100%",margin:"0",padding:"8px 16px"}},{default:o(()=>[a("div",Fe,[a("div",Qe,[a("span",je,[t.coupon.type===1?(r(),m(w,{key:0},[v(" ¥"+_(t.coupon.value),1)],64)):(r(),m(w,{key:1},[v(_(t.coupon.value)+"折 ",1)],64))]),a("div",Re,[a("span",null,_(t.coupon.name),1),a("span",Ge," 满"+_(t.coupon.minAmount)+"元可用 ",1)])]),a("span",He," 有效期至："+_(t.coupon.endTime),1)])]),_:2},1032,["label","disabled"])]))),128))]),_:1},8,["modelValue"]),$.value.length===0?(r(),h(i,{key:0,description:"暂无可用优惠券"},{image:o(()=>[l(A,{size:60},{default:o(()=>[l(k(ge))]),_:1})]),_:1})):M("",!0)])]),_:1})])),[[q,z.value]])]),_:1})]),_:1},8,["model"])])),[[q,D.value]])]),_:1},8,["modelValue"])])}}});export{tt as default};
