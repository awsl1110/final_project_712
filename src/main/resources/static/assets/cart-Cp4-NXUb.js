import{d as ue,r as v,F as D,n as pe,o as i,c as m,b as o,w as s,e as a,I as q,q as w,f as _,u as g,G as I,H as M,T as fe,t as f,M as O,g as ve,E as d,h as u,J as me,N as _e,O as ge,P as ye,Q as he,C as ke,B as we,R as xe,_ as be}from"./index-D07GUNLX.js";import{g as Ce,u as J,b as Ve,r as Ie}from"./cart-BDXYFz_L.js";import{c as Se}from"./order-D29R81T9.js";import{a as $e}from"./address-DxOjfI-V.js";import{g as Ue}from"./coupon-DZ01F3Zd.js";import{f as Ae}from"./date-D_0JMZE-.js";import"./user-B44x33Ff.js";const Ee={class:"cart-container"},Be={class:"cart-content"},De={class:"item-content"},ze={class:"image-placeholder"},Le={class:"item-info"},Ne=["onClick"],Pe={class:"item-price"},Te={class:"item-actions"},qe={class:"footer-content"},Me={class:"footer-left"},Oe={class:"selected-count"},je={class:"footer-right"},Fe={class:"total-price"},Qe={class:"price"},Re={class:"address-form"},Ge={class:"address-info"},He={class:"address-header"},Je={class:"receiver"},Ke={class:"phone"},We={class:"address-content"},Xe={class:"address-actions"},Ye={style:{"max-height":"300px","overflow-y":"auto"}},Ze={style:{padding:"8px 0"}},et={style:{display:"flex","justify-content":"space-between","align-items":"center",width:"100%"}},tt={style:{display:"flex","align-items":"center",gap:"12px"}},lt={style:{color:"var(--el-color-danger)","font-size":"16px","font-weight":"bold","min-width":"80px"}},st={style:{display:"flex","flex-direction":"column",gap:"4px"}},at={style:{color:"var(--el-text-color-secondary)","font-size":"12px"}},ot={style:{color:"var(--el-text-color-secondary)","font-size":"12px"}},nt={class:"dialog-footer"},rt=ue({__name:"cart",setup(dt){const x=ve(),r=v([]),S=v(!0),$=v(null),k=v(0),E=v(""),U=v(!1),C=v([]),z=v(!1),A=v(0),B=v([]),L=v(!1),j=D(()=>r.value.filter(l=>l.selected===1).reduce((l,e)=>l+(e.product.productPrice||0)*e.quantity,0)),F=l=>l?l.toLocaleString():"0",K=async()=>{var l;try{S.value=!0;const c=(await Ce()).data;c.code===200&&(r.value=c.data||[],r.value.forEach(n=>{n.selected=typeof n.selected=="boolean"?n.selected?1:0:n.selected}))}catch(e){((l=e.response)==null?void 0:l.status)===401?d.error("请先登录"):d.error(e.message||"获取购物车列表失败")}finally{S.value=!1}},W=async(l,e)=>{if(!(e<1))try{const n=(await Ve(l.id,e)).data;n.code===200?(l.quantity=e,d.success("更新数量成功")):d.error(n.message||"更新数量失败")}catch{d.error("更新数量失败")}},X=async l=>{try{await xe.confirm("确定要删除这个商品吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),$.value=l.id;const e=await Ie(l.productId);if(e.data){const c=e.data;c.code===200?(r.value=r.value.filter(n=>n.id!==l.id),d.success("删除成功")):d.error(c.message||"删除失败")}else d.error("删除失败")}catch(e){e!=="cancel"&&d.error("删除失败")}finally{$.value=null}},Y=async l=>{try{$.value=l.id;const e=l.selected===1?0:1,c=l.selected;l.selected=e;const n=await J(l.id,e);n.data.code!==200&&(l.selected=c,d.error(n.data.message||"更新选中状态失败"))}catch{l.selected=l.selected===1?0:1,d.error("更新选中状态失败")}finally{$.value=null}},Z=async()=>{try{z.value=!0;const l=await $e.getAddressList();if(l.data.code===200){C.value=l.data.data;const e=C.value.find(c=>c.isDefault);e?k.value=e.id:C.value.length>0&&(k.value=C.value[0].id)}}catch{d.error("获取地址列表失败")}finally{z.value=!1}},ee=async()=>{try{L.value=!0;const l=await Ue();l.data.code===200&&(B.value=l.data.data.filter(e=>e.status===0))}catch{d.error("获取优惠券列表失败")}finally{L.value=!1}},te=()=>{if(r.value.filter(e=>e.selected===1).length===0){d.warning("请选择要结算的商品");return}U.value=!0,Z(),ee()},le=async()=>{var l,e,c;if(!k.value){d.warning("请选择收货地址");return}try{const V={cartIds:r.value.filter(b=>b.selected===1).map(b=>b.id),addressId:k.value,remark:E.value||"",userCouponId:A.value||void 0};if(!localStorage.getItem("token")){d.error("请先登录"),x.push("/login");return}const y=await Se(V);y.data.code===200?(r.value=r.value.filter(b=>b.selected!==1),d.success("订单创建成功"),U.value=!1,x.push(`/order/${y.data.data.id}`)):d.error(y.data.message||"创建订单失败")}catch(n){console.error("创建订单失败:",n),((l=n.response)==null?void 0:l.status)===401?(d.error("请先登录"),x.push("/login")):d.error(((c=(e=n.response)==null?void 0:e.data)==null?void 0:c.message)||"创建订单失败")}},Q=D({get:()=>r.value.length>0&&r.value.every(l=>l.selected===1),set:l=>R(l)}),se=D(()=>{const l=r.value.filter(e=>e.selected===1);return l.length>0&&l.length<r.value.length}),ae=D(()=>r.value.filter(l=>l.selected===1).length),R=async l=>{const e=l?1:0;try{S.value=!0;const c=r.value.map(p=>p.selected);r.value.forEach(p=>p.selected=e),(await Promise.allSettled(r.value.map(p=>J(p.id,e)))).some(p=>p.status==="rejected"||p.status==="fulfilled"&&p.value.data.code!==200)&&(r.value.forEach((p,y)=>{p.selected=c[y]}),d.error("部分商品更新失败"))}catch{d.error("操作失败，请重试")}finally{S.value=!1}};return pe(()=>{K()}),(l,e)=>{const c=u("el-card"),n=u("el-button"),V=u("el-empty"),p=u("el-checkbox"),y=u("el-icon"),b=u("el-image"),oe=u("el-input-number"),ne=u("el-tag"),N=u("el-radio"),G=u("el-radio-group"),re=u("el-link"),P=u("el-form-item"),H=u("el-input"),de=u("el-popover"),ce=u("el-form"),ie=u("el-dialog"),T=me("loading");return i(),m("div",Ee,[o(c,{class:"page-header"},{header:s(()=>e[9]||(e[9]=[a("div",{class:"header"},[a("span",{class:"title"},"购物车")],-1)])),_:1}),q((i(),m("div",Be,[r.value.length===0?(i(),w(V,{key:0,description:"购物车是空的"},{default:s(()=>[o(n,{type:"primary",onClick:e[0]||(e[0]=t=>g(x).push("/products"))},{default:s(()=>e[10]||(e[10]=[_("去购物")])),_:1})]),_:1})):(i(),m(I,{key:1},[o(fe,{name:"cart-item"},{default:s(()=>[(i(!0),m(I,null,M(r.value,t=>(i(),w(c,{key:t.id,class:"cart-item"},{default:s(()=>[a("div",De,[o(p,{modelValue:t.selected,"onUpdate:modelValue":h=>t.selected=h,"true-label":1,"false-label":0,onChange:()=>Y(t)},null,8,["modelValue","onUpdate:modelValue","onChange"]),o(b,{src:t.product.productImage,fit:"cover",class:"product-image","preview-src-list":[t.product.productImage]},{error:s(()=>[a("div",ze,[o(y,null,{default:s(()=>[o(g(_e))]),_:1})])]),_:2},1032,["src","preview-src-list"]),a("div",Le,[a("h3",{class:"item-name",onClick:h=>g(x).push(`/product/${t.product.id}`)},f(t.product.productName),9,Ne),a("div",Pe,"¥"+f(F(t.product.productPrice)),1)]),a("div",Te,[o(oe,{modelValue:t.quantity,"onUpdate:modelValue":h=>t.quantity=h,min:1,max:99,size:"small",onChange:h=>W(t,h),loading:$.value===t.id},{decrease:s(()=>[o(y,null,{default:s(()=>[o(g(ge))]),_:1})]),increase:s(()=>[o(y,null,{default:s(()=>[o(g(ye))]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange","loading"]),o(n,{type:"danger",icon:g(he),circle:"",onClick:h=>X(t)},null,8,["icon","onClick"])])])]),_:2},1024))),128))]),_:1}),r.value.length>0?(i(),w(c,{key:0,class:"cart-footer"},{default:s(()=>[a("div",qe,[a("div",Me,[o(p,{modelValue:Q.value,"onUpdate:modelValue":e[1]||(e[1]=t=>Q.value=t),onChange:R,indeterminate:se.value},{default:s(()=>e[11]||(e[11]=[_(" 全选 ")])),_:1},8,["modelValue","indeterminate"]),a("div",Oe," 已选 "+f(ae.value)+" 件商品 ",1)]),a("div",je,[a("div",Fe,[e[12]||(e[12]=_(" 总计: ")),a("span",Qe,"¥"+f(F(j.value)),1)]),o(n,{type:"primary",size:"large",onClick:te,disabled:!r.value.some(t=>t.selected===1)},{default:s(()=>e[13]||(e[13]=[_(" 结算 ")])),_:1},8,["disabled"])])])]),_:1})):O("",!0)],64))])),[[T,S.value]]),o(ie,{modelValue:U.value,"onUpdate:modelValue":e[8]||(e[8]=t=>U.value=t),title:"选择收货地址",width:"50%","close-on-click-modal":!1},{footer:s(()=>[a("span",nt,[o(n,{onClick:e[7]||(e[7]=t=>U.value=!1)},{default:s(()=>e[18]||(e[18]=[_("取消")])),_:1}),o(n,{type:"primary",onClick:le,disabled:!k.value},{default:s(()=>e[19]||(e[19]=[_(" 提交订单 ")])),_:1},8,["disabled"])])]),default:s(()=>[q((i(),m("div",Re,[o(ce,{model:{addressId:k.value,remark:E.value},"label-width":"100px"},{default:s(()=>[o(P,{label:"收货地址",required:""},{default:s(()=>[C.value.length===0?(i(),w(V,{key:0,description:"暂无收货地址"},{default:s(()=>[o(n,{type:"primary",onClick:e[2]||(e[2]=t=>g(x).push("/address"))},{default:s(()=>e[14]||(e[14]=[_(" 添加收货地址 ")])),_:1})]),_:1})):(i(),w(G,{key:1,modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=t=>k.value=t),class:"address-list"},{default:s(()=>[(i(!0),m(I,null,M(C.value,t=>(i(),w(N,{key:t.id,label:t.id,class:"address-item"},{default:s(()=>[a("div",Ge,[a("div",He,[a("span",Je,f(t.receiverName),1),a("span",Ke,f(t.receiverPhone),1),t.isDefault?(i(),w(ne,{key:0,size:"small",type:"success"},{default:s(()=>e[15]||(e[15]=[_("默认")])),_:1})):O("",!0)]),a("div",We,f(`${t.province}${t.city}${t.district}${t.detailAddress}`),1)])]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])),a("div",Xe,[o(re,{type:"primary",onClick:e[4]||(e[4]=t=>g(x).push("/address"))},{default:s(()=>e[16]||(e[16]=[_(" 管理收货地址 ")])),_:1})])]),_:1}),o(P,{label:"订单备注"},{default:s(()=>[o(H,{modelValue:E.value,"onUpdate:modelValue":e[5]||(e[5]=t=>E.value=t),type:"textarea",rows:3,placeholder:"请输入订单备注（选填）"},null,8,["modelValue"])]),_:1}),o(P,{label:"优惠券"},{default:s(()=>[q((i(),m("div",null,[o(de,{placement:"bottom-start",width:400,trigger:"click","popper-class":"coupon-popover"},{reference:s(()=>{var t;return[o(H,{readonly:"",placeholder:A.value===0?"不使用优惠券":((t=B.value.find(h=>h.id===A.value))==null?void 0:t.coupon.name)||"请选择优惠券","suffix-icon":g(ke),style:{width:"100%"}},null,8,["placeholder","suffix-icon"])]}),default:s(()=>[a("div",Ye,[o(G,{modelValue:A.value,"onUpdate:modelValue":e[6]||(e[6]=t=>A.value=t),style:{width:"100%"}},{default:s(()=>[a("div",Ze,[o(N,{label:0,style:{width:"100%",margin:"0",padding:"8px 16px"}},{default:s(()=>e[17]||(e[17]=[a("div",{style:{display:"flex","justify-content":"space-between","align-items":"center",width:"100%"}},[a("span",null,"不使用优惠券"),a("span",{style:{color:"var(--el-text-color-secondary)"}},"按原价支付")],-1)])),_:1})]),(i(!0),m(I,null,M(B.value,t=>(i(),m("div",{key:t.id,style:{padding:"4px 0"}},[o(N,{label:t.id,disabled:t.coupon.minAmount>j.value,style:{width:"100%",margin:"0",padding:"8px 16px"}},{default:s(()=>[a("div",et,[a("div",tt,[a("span",lt,[t.coupon.type===1?(i(),m(I,{key:0},[_(" ¥"+f(t.coupon.value),1)],64)):(i(),m(I,{key:1},[_(f(t.coupon.value)+"折 ",1)],64))]),a("div",st,[a("span",null,f(t.coupon.name),1),a("span",at," 满"+f(t.coupon.minAmount)+"元可用 ",1)])]),a("span",ot," 有效期至："+f(g(Ae)(t.coupon.endTime)),1)])]),_:2},1032,["label","disabled"])]))),128))]),_:1},8,["modelValue"]),B.value.length===0?(i(),w(V,{key:0,description:"暂无可用优惠券"},{image:s(()=>[o(y,{size:60},{default:s(()=>[o(g(we))]),_:1})]),_:1})):O("",!0)])]),_:1})])),[[T,L.value]])]),_:1})]),_:1},8,["model"])])),[[T,z.value]])]),_:1},8,["modelValue"])])}}}),_t=be(rt,[["__scopeId","data-v-06bc3633"]]);export{_t as default};
